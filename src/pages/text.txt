import React, { useState } from "react";
import perfil from "../assets/perfil.png";
import dinheiro from "../assets/dinheiro.png";
import livroUm from "../assets/livroUm.png";
import seguro from "../assets/seguro.png";
import garantia from "../assets/garantia.webp";

export default function Checkout() {
  const [form, setForm] = useState({
    email: "",
    pagamento: "pix",
    celular: "",
  });

  const [loading, setLoading] = useState(false);
  const [qrCodeData, setQrCodeData] = useState(null);

  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      const paymentData = {
        pagamento: form.pagamento,
        email: form.email,
        celular: form.celular,
      };

      if (form.pagamento === "cartao") {
        paymentData.cartao = {
          number: document.getElementById("cardNumber").value,
          exp_month: document.getElementById("expMonth").value,
          exp_year: document.getElementById("expYear").value,
          cvv: document.getElementById("cvv").value,
          name: document.getElementById("cardholderName").value,
          cpf: document.getElementById("cpf").value,
        };
      }

      const res = await fetch(
        "http://127.0.0.1:5001/stripepay-3c918/us-central1/api/realizarPagamento", // ⬅️ Atualize com seu endpoint
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(paymentData),
        }
      );

      const data = await res.json();

      if (form.pagamento === "pix") {
        setQrCodeData(data.qr_code); // Backend deve retornar isso
      } else if (data.status === "approved") {
        alert("Pagamento com cartão aprovado!");
      } else {
        alert("Erro no pagamento: " + data.message);
      }
    } catch (error) {
      console.error(error);
      alert("Erro ao processar pagamento");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex justify-around bg-gray-100 py-4 px-4 md:px-20">
      <form
        onSubmit={handleSubmit}
        className="max-w-4xl flex-1 bg-white p-6 rounded-xl shadow-md space-y-8"
      >
        {/* Produto */}
        <section className="flex items-center gap-4">
          <img src={livroUm} alt="Capa" className="w-16 h-16 rounded-md" />
          <div>
            <h1 className="font-black text-lg">Lucrando com a Páscoa</h1>
            <p className="text-green-700 font-semibold">2 x de R$ 10,90</p>
            <p className="text-gray-500 text-sm">ou R$ 21,80 à vista</p>
          </div>
        </section>

        {/* Dados */}
        <section>
          <div className="space-y-4">
            <input
              type="email"
              name="email"
              placeholder="Preencha com seu email"
              required
              className="input"
              value={form.email}
              onChange={handleChange}
            />
            <input
              type="tel"
              name="celular"
              placeholder="Preencha com seu celular"
              required
              className="input"
              value={form.celular}
              onChange={handleChange}
            />
          </div>
        </section>

        {/* Pagamento */}
        <section>
          <div className="flex gap-4">
            <button
              type="button"
              onClick={() => setForm({ ...form, pagamento: "pix" })}
              className={flex-1 h-16 rounded-md font-semibold border-2 transition ${
                form.pagamento === "pix"
                  ? "bg-green-700 text-white border-green-700"
                  : "bg-white text-black border-gray-300"
              }}
            >
              PIX
            </button>
            <button
              type="button"
              onClick={() => setForm({ ...form, pagamento: "cartao" })}
              className={flex-1 h-16 rounded-md font-semibold border-2 transition ${
                form.pagamento === "cartao"
                  ? "bg-green-700 text-white border-green-700"
                  : "bg-white text-black border-gray-300"
              }}
            >
              Cartão de Crédito
            </button>
          </div>
          {form.pagamento === "pix" && (
            <div className="mt-4 p-4 border-2 border-dashed border-green-700 text-sm rounded-md space-y-4">
              <p>✅ Liberação imediata</p>
              <p>✅ Pague escaneando o QR Code abaixo</p>
              {qrCodeData && (
                <>
                  <img
                    src={qrCodeData.qr_code_base64}
                    alt="QR Code PIX"
                    className="mx-auto max-w-xs border rounded-md"
                  />
                  <p className="text-center text-xs break-words">
                    {qrCodeData.qr_code}
                  </p>
                </>
              )}
            </div>
          )}
          {form.pagamento === "pix" && qrCodeData && (
            <div className="mt-4">
              <img
                src={qrCodeData.qr_code_base64}
                alt="QR Code PIX"
                className="mx-auto max-w-xs border rounded-md"
              />
              <p className="text-center text-xs mt-2">{qrCodeData.qr_code}</p>
            </div>
          )}

          {form.pagamento === "cartao" && (
            <div className="space-y-4 mt-4">
              <input
                id="cardNumber"
                placeholder="Número do Cartão"
                className="input"
                required
              />
              <div className="flex gap-2">
                <input
                  id="expMonth"
                  placeholder="Mes de vencimento"
                  className="input w-1/3"
                  required
                />
                <input
                  id="expYear"
                  placeholder="Ano de vencimento"
                  className="input w-1/3"
                  required
                />
                <input
                  id="cvv"
                  placeholder="CVV"
                  className="input w-1/3"
                  required
                />
              </div>
              <input
                id="cardholderName"
                placeholder="Nome do Titular"
                className="input"
                required
              />
              <input
                id="cpf"
                placeholder="CPF do Titular"
                className="input"
                required
              />
            </div>
          )}
        </section>

        <button
          type="submit"
          disabled={loading}
          className="mt-4 w-full bg-green-700 hover:bg-green-800 text-white py-3 rounded-md font-bold"
        >
          {loading
            ? "Processando..."
            : form.pagamento === "pix"
            ? "Gerar QR Code PIX"
            : "Pagar com Cartão"}
        </button>

        <section className="text-center text-xs text-gray-500 mt-6">
          <div className="flex items-center justify-center gap-2">
            <img src={seguro} alt="Cadeado" className="size-4" />
            Compra 100% segura
          </div>
          <p className="mt-2">
            Política de Privacidade e Termos de Serviço aplicáveis.
          </p>
        </section>
      </form>
      <section className="flex flex-col gap-2 justify-start items-center rounded-xl w-96 px-4 py-10 bg-white shadow-md">
        <h1 className="font-bold text-2xl">Resumo da compra</h1>
        <div className="px-10 my-10 flex justify-between items-start w-full">
          <p className="font-medium">items:</p>
          <div className="flex flex-col items-end gap-4">
            <p className="font-medium">Lucrando com a Pascoa</p>
            <img src={livroUm} alt="" className="w-[100px]" />
          </div>
        </div>
        <div className="flex justify-between w-full px-10">
          <p className="font-medium">Valor do produto:</p>
          <p className="font-bold">R$21,80</p>
        </div>
        <div className="flex justify-between w-full px-10">
          <p className="font-medium">Descontos:</p>
          <p className="font-bold">R$0,00</p>
        </div>
        <div className="flex justify-between w-full px-10">
          <p className="font-medium">Taxas de entrega:</p>
          <p className="font-bold">R$0,00</p>
        </div>

        <div className="mt-10 flex justify-between w-full px-10">
          <p className="font-medium">Total a ser pago:</p>
          <p className="font-bold text-green-500">R$21,80</p>
        </div>
        <img src={garantia} alt="" className="w-40 mt-4" />
      </section>
    </div>
  );
}